<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>貿易シミュレーション</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .game-container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        h1, h2, h3 {
            color: #2c3e50;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .stats {
            display: flex;
            gap: 20px;
        }
        
        .stat-item {
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .cities-container {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .city {
            flex: 1;
            min-width: 200px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 5px solid #3498db;
            margin-bottom: 10px;
        }
        
        .city-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #3498db;
            font-size: 18px;
        }
        
        .travel-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .travel-btn:hover {
            background-color: #2980b9;
        }
        
        .travel-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .market-container {
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .buy-btn, .sell-btn {
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .buy-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .buy-btn:hover {
            background-color: #27ae60;
        }
        
        .sell-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .sell-btn:hover {
            background-color: #c0392b;
        }
        
        .buy-btn:disabled, .sell-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .quantity-input {
            width: 50px;
            text-align: center;
        }
        
        .cargo-container {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        
        .cargo-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .spoil-warning {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .good-spoiled {
            color: #e74c3c;
            text-decoration: line-through;
        }
        
        .advance-day {
            background-color: #9b59b6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .advance-day:hover {
            background-color: #8e44ad;
        }
        
        .game-log {
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        
        .log-entry {
            margin: 5px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
        }
        
        .tab-btn {
            padding: 10px 15px;
            background-color: #f0f0f0;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn.active {
            border-bottom: 2px solid #3498db;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 10px;
            background-color: #fff;
            border-top: 1px solid #ddd;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .price-up {
            color: green;
            font-weight: bold;
        }
        
        .price-down {
            color: red;
            font-weight: bold;
        }
        
        .city-specialty {
            margin-top: 10px;
            font-style: italic;
            color: #555;
        }
        
        .good-profit {
            background-color: #e6ffe6;
        }
        
        /* レスポンシブデザイン */
        @media (max-width: 768px) {
            .cities-container {
                flex-direction: column;
            }
            
            .city {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>大航海貿易シミュレーション</h1>
            <div class="stats">
                <div class="stat-item" id="day-display">日数: 1</div>
                <div class="stat-item" id="money-display">所持金: 1000 金貨</div>
                <div class="stat-item" id="location-display">現在地: リスボン</div>
            </div>
        </div>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="city-tab">都市と移動</button>
                <button class="tab-btn" data-tab="market-tab">市場</button>
                <button class="tab-btn" data-tab="cargo-tab">所持品</button>
                <button class="tab-btn" data-tab="log-tab">ログ</button>
            </div>
            
            <div class="tab-content active" id="city-tab">
                <h2>利用可能な港</h2>
                <div class="cities-container" id="cities-list">
                    <!-- 都市リストはJSで動的に生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="market-tab">
                <h2>市場価格</h2>
                <div class="market-container">
                    <table id="market-table">
                        <thead>
                            <tr>
                                <th>商品</th>
                                <th>カテゴリ</th>
                                <th>購入価格</th>
                                <th>販売価格</th>
                                <th>在庫数</th>
                                <th>需要</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="market-body">
                            <!-- 市場データはJSで動的に生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="cargo-tab">
                <h2>所持品</h2>
                <div class="cargo-container">
                    <table id="cargo-table">
                        <thead>
                            <tr>
                                <th>商品</th>
                                <th>数量</th>
                                <th>購入価格</th>
                                <th>現在の推定価値</th>
                                <th>状態</th>
                                <th>利益予測</th>
                            </tr>
                        </thead>
                        <tbody id="cargo-body">
                            <!-- 所持品データはJSで動的に生成 -->
                        </tbody>
                    </table>
                    <p>総貨物容量: <span id="cargo-capacity">0</span> / <span id="max-cargo-capacity">100</span></p>
                </div>
            </div>
            
            <div class="tab-content" id="log-tab">
                <h2>取引ログ</h2>
                <div class="game-log" id="game-log">
                    <!-- ログはJSで動的に生成 -->
                </div>
            </div>
        </div>
        
        <button class="advance-day" id="advance-day-btn">次の日へ進む</button>
    </div>

    <script>
        // ゲームデータ
        const gameState = {
            day: 1,
            money: 1000,
            currentCity: "リスボン",
            cargoCapacity: 0,
            maxCargoCapacity: 100,
            cargo: [], // {id, name, quantity, purchasePrice, daysHeld, spoilage}
            logs: []
        };
        
        // 都市データ
        const cities = [
            {
                id: "lisbon",
                name: "リスボン",
                description: "ポルトガルの首都。ヨーロッパの中心的貿易港。",
                connections: ["london", "venice", "tunis"],
                travelDays: {"london": 5, "venice": 8, "tunis": 6}
            },
            {
                id: "london",
                name: "ロンドン",
                description: "イギリスの首都。毛織物や工芸品が豊富。",
                connections: ["lisbon", "amsterdam"],
                travelDays: {"lisbon": 5, "amsterdam": 3}
            },
            {
                id: "venice",
                name: "ベネチア",
                description: "地中海の商業共和国。香辛料や絹の取引で栄える。",
                connections: ["lisbon", "alexandria", "istanbul"],
                travelDays: {"lisbon": 8, "alexandria": 7, "istanbul": 6}
            },
            {
                id: "amsterdam",
                name: "アムステルダム",
                description: "オランダの商業中心。金融と造船業が発達。",
                connections: ["london", "hamburg"],
                travelDays: {"london": 3, "hamburg": 2}
            },
            {
                id: "alexandria",
                name: "アレクサンドリア",
                description: "エジプトの港町。アフリカからの珍しい商品の集散地。",
                connections: ["venice", "istanbul"],
                travelDays: {"venice": 7, "istanbul": 5}
            },
            {
                id: "istanbul",
                name: "イスタンブール",
                description: "オスマン帝国の首都。東西の文化が交わる交易拠点。",
                connections: ["venice", "alexandria"],
                travelDays: {"venice": 6, "alexandria": 5}
            },
            {
                id: "tunis",
                name: "チュニス",
                description: "北アフリカの港町。砂糖と香料の取引が盛ん。",
                connections: ["lisbon"],
                travelDays: {"lisbon": 6}
            },
            {
                id: "hamburg",
                name: "ハンブルク",
                description: "ドイツの自由都市。バルト海貿易の拠点。",
                connections: ["amsterdam"],
                travelDays: {"amsterdam": 2}
            }
        ];
        
        // 商品データ
        const goods = [
            {
                id: "wheat",
                name: "小麦",
                category: "食料",
                basePrice: 20,
                spoilage: 30, // 何日で腐るか
                volatility: 0.2, // 価格変動の度合い
                baseQuantity: {min: 50, max: 100},
                weight: 1
            },
            {
                id: "fish",
                name: "魚",
                category: "食料",
                basePrice: 30,
                spoilage: 5, // 腐りやすい
                volatility: 0.3,
                baseQuantity: {min: 30, max: 80},
                weight: 1
            },
            {
                id: "meat",
                name: "肉",
                category: "食料",
                basePrice: 50,
                spoilage: 8,
                volatility: 0.25,
                baseQuantity: {min: 20, max: 50},
                weight: 1
            },
            {
                id: "salt",
                name: "塩",
                category: "調味料",
                basePrice: 40,
                spoilage: 0, // 腐らない
                volatility: 0.15,
                baseQuantity: {min: 30, max: 70},
                weight: 1
            },
            {
                id: "spices",
                name: "香辛料",
                category: "調味料",
                basePrice: 80,
                spoilage: 60, // あまり腐らない
                volatility: 0.4,
                baseQuantity: {min: 10, max: 30},
                weight: 1
            },
            {
                id: "wine",
                name: "ワイン",
                category: "飲料",
                basePrice: 60,
                spoilage: 90, // 長持ちする
                volatility: 0.2,
                baseQuantity: {min: 20, max: 60},
                weight: 2
            },
            {
                id: "cloth",
                name: "布地",
                category: "織物",
                basePrice: 70,
                spoilage: 0, // 腐らない
                volatility: 0.2,
                baseQuantity: {min: 20, max: 50},
                weight: 2
            },
            {
                id: "silk",
                name: "絹",
                category: "織物",
                basePrice: 150,
                spoilage: 0, // 腐らない
                volatility: 0.3,
                baseQuantity: {min: 5, max: 25},
                weight: 1
            },
            {
                id: "timber",
                name: "木材",
                category: "資材",
                basePrice: 45,
                spoilage: 0, // 腐らない
                volatility: 0.1,
                baseQuantity: {min: 30, max: 80},
                weight: 3
            },
            {
                id: "metals",
                name: "金属",
                category: "資材",
                basePrice: 90,
                spoilage: 0, // 腐らない
                volatility: 0.15,
                baseQuantity: {min: 15, max: 40},
                weight: 4
            },
            {
                id: "jewelry",
                name: "宝飾品",
                category: "贅沢品",
                basePrice: 200,
                spoilage: 0, // 腐らない
                volatility: 0.4,
                baseQuantity: {min: 3, max: 15},
                weight: 1
            },
            {
                id: "pottery",
                name: "陶器",
                category: "工芸品",
                basePrice: 55,
                spoilage: 0, // 腐らない
                volatility: 0.2,
                baseQuantity: {min: 15, max: 45},
                weight: 2
            }
        ];
        
        // 都市ごとの商品特性（需要と供給）
        const cityGoodsTrait = {
            "lisbon": {
                high_supply: ["wine", "salt", "fish"],
                high_demand: ["silk", "spices", "jewelry"]
            },
            "london": {
                high_supply: ["cloth", "metals", "fish"],
                high_demand: ["wine", "spices", "timber"]
            },
            "venice": {
                high_supply: ["silk", "pottery", "jewelry"],
                high_demand: ["metals", "timber", "wheat"]
            },
            "amsterdam": {
                high_supply: ["cloth", "pottery", "fish"],
                high_demand: ["wine", "silk", "spices"]
            },
            "alexandria": {
                high_supply: ["spices", "wheat", "pottery"],
                high_demand: ["metals", "cloth", "wine"]
            },
            "istanbul": {
                high_supply: ["spices", "silk", "jewelry"],
                high_demand: ["metals", "timber", "salt"]
            },
            "tunis": {
                high_supply: ["spices", "salt", "wheat"],
                high_demand: ["cloth", "metals", "pottery"]
            },
            "hamburg": {
                high_supply: ["timber", "metals", "fish"],
                high_demand: ["silk", "spices", "jewelry"]
            }
        };
        
        // 市場データ（都市ごとの在庫と価格）
        let marketData = {};
        
        // 市場データを初期化
        function initializeMarkets() {
            cities.forEach(city => {
                marketData[city.id] = {};
                
                goods.forEach(good => {
                    // 需要と供給の修飾子を決定
                    let demandModifier = 1.0;
                    let supplyModifier = 1.0;
                    
                    // 高需要商品の場合
                    if (cityGoodsTrait[city.id].high_demand.includes(good.id)) {
                        demandModifier = 2.0; // 価格上昇（修正：より大きな差に）
                        supplyModifier = 0.6; // 在庫減少
                    }
                    
                    // 高供給商品の場合
                    if (cityGoodsTrait[city.id].high_supply.includes(good.id)) {
                        demandModifier = 0.5; // 価格低下（修正：より大きな差に）
                        supplyModifier = 1.8; // 在庫増加
                    }
                    
                    // ランダム要素を加える
                    const randomDemand = 0.8 + Math.random() * 0.4; // 0.8-1.2
                    const randomSupply = 0.8 + Math.random() * 0.4; // 0.8-1.2
                    
                    // 価格計算
                    const basePrice = good.basePrice;
                    const buyPrice = Math.round(basePrice * demandModifier * randomDemand);
                    
                    // 販売価格は購入価格の85%（修正：利益が出やすいように）
                    // ただし同じ都市内でのみの売買を想定
                    const sellPrice = Math.round(buyPrice * 0.85);
                    
                    // 在庫計算
                    const minQuantity = good.baseQuantity.min;
                    const maxQuantity = good.baseQuantity.max;
                    const quantity = Math.round((minQuantity + Math.random() * (maxQuantity - minQuantity)) * supplyModifier * randomSupply);
                    
                    // 需要度（0-10）
                    const demand = Math.round(demandModifier * randomDemand * 5);
                    
                    marketData[city.id][good.id] = {
                        buyPrice: buyPrice,
                        sellPrice: sellPrice,
                        quantity: quantity,
                        demand: demand
                    };
                });
            });
        }
        
        // 市場データを更新（日数経過時）
        function updateMarkets() {
            cities.forEach(city => {
                goods.forEach(good => {
                    const market = marketData[city.id][good.id];
                    
                    // 基本的な需要と供給の修飾子
                    let demandModifier = 1.0;
                    let supplyModifier = 1.0;
                    
                    // 高需要商品の場合
                    if (cityGoodsTrait[city.id].high_demand.includes(good.id)) {
                        demandModifier = 1.5;
                        supplyModifier = 0.8;
                    }
                    
                    // 高供給商品の場合
                    if (cityGoodsTrait[city.id].high_supply.includes(good.id)) {
                        demandModifier = 0.8;
                        supplyModifier = 1.3;
                    }
                    
                    // ランダム要素
                    const randomFactor = 0.9 + Math.random() * 0.2; // 0.9-1.1
                    
                    // 在庫が少ない場合、需要増加・価格上昇
                    const quantityFactor = Math.max(0.5, Math.min(1.5, 1 + (good.baseQuantity.max / 2 - market.quantity) / (good.baseQuantity.max / 2)));
                    
                    // 価格更新
                    const volatilityFactor = 1 + (Math.random() * 2 - 1) * good.volatility;
                    const newBuyPrice = Math.round(market.buyPrice * randomFactor * volatilityFactor * (1 + (quantityFactor - 1) * 0.5));
                    market.buyPrice = Math.max(Math.round(good.basePrice * 0.5), Math.min(Math.round(good.basePrice * 3.0), newBuyPrice));
                    market.sellPrice = Math.round(market.buyPrice * 0.85);
                    
                    // 在庫更新（基本的に元に戻る傾向）
                    const baseStockLevel = (good.baseQuantity.min + good.baseQuantity.max) / 2 * supplyModifier;
                    const restockRate = 0.2; // 20%の速度で理想在庫に近づく
                    const restockAmount = Math.round((baseStockLevel - market.quantity) * restockRate);
                    market.quantity = Math.max(0, market.quantity + restockAmount);
                    
                    // 需要更新
                    market.demand = Math.round(Math.max(1, Math.min(10, market.demand * randomFactor * demandModifier)));
                });
            });
        }
        
        // UI要素の参照を取得
        const dayDisplay = document.getElementById('day-display');
        const moneyDisplay = document.getElementById('money-display');
        const locationDisplay = document.getElementById('location-display');
        const citiesList = document.getElementById('cities-list');
        const marketBody = document.getElementById('market-body');
        const cargoBody = document.getElementById('cargo-body');
        const cargoCapacity = document.getElementById('cargo-capacity');
        const maxCargoCapacity = document.getElementById('max-cargo-capacity');
        const advanceDayBtn = document.getElementById('advance-day-btn');
        const gameLog = document.getElementById('game-log');
        
        // タブ切り替え
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                // すべてのタブボタンからアクティブクラスを削除
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // クリックされたボタンにアクティブクラスを追加
                button.classList.add('active');
                
                // すべてのタブコンテンツを非表示
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // クリックされたボタンに対応するタブコンテンツを表示
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // 都市リストを描画
        function renderCities() {
            citiesList.innerHTML = '';
            
            cities.forEach(city => {
                const cityElement = document.createElement('div');
                cityElement.className = 'city';
                
                const isCurrentCity = city.id === getCityIdByName(gameState.currentCity);
                
                let specialties = '';
                if (cityGoodsTrait[city.id].high_supply.length > 0) {
                    const supplyNames = cityGoodsTrait[city.id].high_supply.map(id => {
                        const good = goods.find(g => g.id === id);
                        return good ? good.name : '';
                    }).join('、');
                    specialties += `<div class="city-specialty">供給: ${supplyNames}</div>`;
                }
                
                if (cityGoodsTrait[city.id].high_demand.length > 0) {
                    const demandNames = cityGoodsTrait[city.id].high_demand.map(id => {
                        const good = goods.find(g => g.id === id);
                        return good ? good.name : '';
                    }).join('、');
                    specialties += `<div class="city-specialty">需要: ${demandNames}</div>`;
                }
                
                let cityHTML = `
                    <div class="city-name">${city.name}</div>
                    <div>${city.description}</div>
                    ${specialties}
                `;
                
                if (!isCurrentCity) {
                    const currentCityId = getCityIdByName(gameState.currentCity);
                    const currentCity = cities.find(c => c.id === currentCityId);
                    
                    if (currentCity.connections.includes(city.id)) {
                        const travelDays = currentCity.travelDays[city.id];
                        cityHTML += `
                            <button class="travel-btn" data-city="${city.id}" data-days="${travelDays}">
                                移動する（${travelDays}日）
                            </button>
                        `;
                    }
                } else {
                    cityHTML += `<div><strong>現在位置</strong></div>`;
                }
                
                cityElement.innerHTML = cityHTML;
                citiesList.appendChild(cityElement);
            });
            
            // 移動ボタンのイベントリスナーを設定
            document.querySelectorAll('.travel-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const cityId = button.getAttribute('data-city');
                    const days = parseInt(button.getAttribute('data-days'));
                    travelToCity(cityId, days);
                });
            });
        }
        
        // 市場データを描画
        function renderMarket() {
            marketBody.innerHTML = '';
            
            const currentCityId = getCityIdByName(gameState.currentCity);
            
            goods.forEach(good => {
                const market = marketData[currentCityId][good.id];
                
                const tr = document.createElement('tr');
                
                // 高需要/高供給に基づいて行の色を変える
                if (cityGoodsTrait[currentCityId].high_supply.includes(good.id)) {
                    tr.classList.add('good-profit'); // 安く買える商品
                }
                
                // 需要に応じた表示（★の数）
                let demandDisplay = '';
                for (let i = 0; i < market.demand; i++) {
                    demandDisplay += '★';
                }
                
                // 他都市での価格を確認して売却候補かどうか判断
                let bestSellCity = '';
                let bestSellPrice = 0;
                
                cities.forEach(city => {
                    if (city.id !== currentCityId) {
                        const cityMarket = marketData[city.id][good.id];
                        if (cityMarket.sellPrice > bestSellPrice) {
                            bestSellPrice = cityMarket.sellPrice;
                            bestSellCity = city.name;
                        }
                    }
                });
                
                // 販売価格の色を決定（現在の都市より高い場合は緑、低い場合は赤）
                const priceClass = bestSellPrice > market.sellPrice ? 'price-up' : 'price-down';
                
                let priceInfo = '';
                if (bestSellCity) {
                    const priceDiff = bestSellPrice - market.buyPrice;
                    const profitPercent = Math.round((priceDiff / market.buyPrice) * 100);
                    priceInfo = `<div class="${priceClass}">最高売却: ${bestSellCity} (${bestSellPrice}金貨、利益${profitPercent}%)</div>`;
                }
                
                tr.innerHTML = `
                    <td>${good.name}</td>
                    <td>${good.category}</td>
                    <td>${market.buyPrice} 金貨 ${priceInfo}</td>
                    <td>${market.sellPrice} 金貨</td>
                    <td>${market.quantity}</td>
                    <td>${demandDisplay}</td>
                    <td class="action-buttons">
                        <input type="number" class="quantity-input" min="1" max="10" value="1">
                        <button class="buy-btn" data-good="${good.id}">購入</button>
                        <button class="sell-btn" data-good="${good.id}">販売</button>
                    </td>
                `;
                
                marketBody.appendChild(tr);
            });
            
            // 購入・販売ボタンのイベントリスナーを設定
            document.querySelectorAll('.buy-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const goodId = button.getAttribute('data-good');
                    const quantityInput = button.parentElement.querySelector('.quantity-input');
                    const quantity = parseInt(quantityInput.value);
                    buyGoods(goodId, quantity);
                });
            });
            
            document.querySelectorAll('.sell-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const goodId = button.getAttribute('data-good');
                    const quantityInput = button.parentElement.querySelector('.quantity-input');
                    const quantity = parseInt(quantityInput.value);
                    sellGoods(goodId, quantity);
                });
            });
        }
        
        // 所持品を描画
        function renderCargo() {
            cargoBody.innerHTML = '';
            
            if (gameState.cargo.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" style="text-align: center;">所持品はありません。</td>';
                cargoBody.appendChild(tr);
            } else {
                gameState.cargo.forEach(item => {
                    const good = goods.find(g => g.id === item.id);
                    const currentCityId = getCityIdByName(gameState.currentCity);
                    const currentMarketPrice = marketData[currentCityId][item.id].sellPrice;
                    const currentValue = currentMarketPrice * item.quantity;
                    const purchaseValue = item.purchasePrice * item.quantity;
                    const profit = currentValue - purchaseValue;
                    
                    // 腐敗度の計算
                    let spoilageStatus = '';
                    if (good.spoilage > 0) {
                        const spoilagePercent = Math.round(item.daysHeld / good.spoilage * 100);
                        if (spoilagePercent >= 100) {
                            spoilageStatus = '<span class="good-spoiled">腐敗</span>';
                        } else if (spoilagePercent >= 75) {
                            spoilageStatus = '<span class="spoil-warning">危険 (あと' + (good.spoilage - item.daysHeld) + '日)</span>';
                        } else if (spoilagePercent >= 50) {
                            spoilageStatus = '劣化中 (あと' + (good.spoilage - item.daysHeld) + '日)';
                        } else {
                            spoilageStatus = '良好 (あと' + (good.spoilage - item.daysHeld) + '日)';
                        }
                    } else {
                        spoilageStatus = '変化なし';
                    }
                    
                    // 最も利益の出る都市を探す
                    let bestCity = '';
                    let bestProfit = profit;
                    
                    cities.forEach(city => {
                        if (city.id !== currentCityId) {
                            const cityMarket = marketData[city.id][item.id];
                            const cityProfit = (cityMarket.sellPrice * item.quantity) - purchaseValue;
                            if (cityProfit > bestProfit) {
                                bestProfit = cityProfit;
                                bestCity = city.name;
                            }
                        }
                    });
                    
                    let profitInfo = '';
                    if (bestCity && bestProfit > profit) {
                        const profitPercent = Math.round((bestProfit / purchaseValue) * 100);
                        profitInfo = `${bestCity}で売れば${bestProfit}金貨の利益 (${profitPercent}%)`;
                    } else {
                        const profitPercent = Math.round((profit / purchaseValue) * 100);
                        profitInfo = `現在地で${profit}金貨の利益 (${profitPercent}%)`;
                    }
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${good.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.purchasePrice} 金貨</td>
                        <td>${currentMarketPrice} 金貨 <span style="color: ${profit >= 0 ? 'green' : 'red'};">(${profit >= 0 ? '+' : ''}${profit})</span></td>
                        <td>${spoilageStatus}</td>
                        <td>${profitInfo}</td>
                    `;
                    
                    cargoBody.appendChild(tr);
                });
            }
            
            // 貨物容量の表示更新
            cargoCapacity.textContent = gameState.cargoCapacity;
            maxCargoCapacity.textContent = gameState.maxCargoCapacity;
        }
        
        // 都市名からIDを取得
        function getCityIdByName(cityName) {
            const city = cities.find(c => c.name === cityName);
            return city ? city.id : null;
        }
        
        // 都市IDから名前を取得
        function getCityNameById(cityId) {
            const city = cities.find(c => c.id === cityId);
            return city ? city.name : null;
        }
        
        // 商品を購入
        function buyGoods(goodId, quantity) {
            const currentCityId = getCityIdByName(gameState.currentCity);
            const market = marketData[currentCityId][goodId];
            const good = goods.find(g => g.id === goodId);
            
            if (!market || !good) return;
            
            // 在庫確認
            if (market.quantity < quantity) {
                addLogMessage(`${good.name}の在庫が足りません。（在庫: ${market.quantity}）`);
                return;
            }
            
            // 貨物容量確認
            const requiredCapacity = good.weight * quantity;
            if (gameState.cargoCapacity + requiredCapacity > gameState.maxCargoCapacity) {
                addLogMessage(`貨物容量が足りません。必要容量: ${requiredCapacity}、残り容量: ${gameState.maxCargoCapacity - gameState.cargoCapacity}`);
                return;
            }
            
            // 所持金確認
            const totalCost = market.buyPrice * quantity;
            if (gameState.money < totalCost) {
                addLogMessage(`所持金が足りません。必要金額: ${totalCost}金貨、所持金: ${gameState.money}金貨`);
                return;
            }
            
            // 購入処理
            gameState.money -= totalCost;
            market.quantity -= quantity;
            
            // 既に所持している場合は数量を追加
            const existingItem = gameState.cargo.find(item => item.id === goodId);
            if (existingItem) {
                // 平均購入価格を計算
                const totalOldValue = existingItem.purchasePrice * existingItem.quantity;
                const totalNewValue = market.buyPrice * quantity;
                const totalQuantity = existingItem.quantity + quantity;
                const averagePrice = Math.round((totalOldValue + totalNewValue) / totalQuantity);
                
                existingItem.quantity += quantity;
                existingItem.purchasePrice = averagePrice;
            } else {
                // 新規アイテムとして追加
                gameState.cargo.push({
                    id: goodId,
                    name: good.name,
                    quantity: quantity,
                    purchasePrice: market.buyPrice,
                    daysHeld: 0
                });
            }
            
            // 貨物容量を更新
            gameState.cargoCapacity += requiredCapacity;
            
            // UI更新
            updateUI();
            
            // ログに記録
            addLogMessage(`${good.name}を${quantity}個、${totalCost}金貨で購入しました。`);
            
            // 売却可能な都市を提案
            let bestSellCity = '';
            let bestSellPrice = 0;
            let bestProfit = 0;
            
            cities.forEach(city => {
                if (city.id !== currentCityId) {
                    const cityMarket = marketData[city.id][goodId];
                    const profit = cityMarket.sellPrice - market.buyPrice;
                    if (profit > bestProfit) {
                        bestProfit = profit;
                        bestSellPrice = cityMarket.sellPrice;
                        bestSellCity = city.name;
                    }
                }
            });
            
            if (bestSellCity && bestProfit > 0) {
                const profitPercent = Math.round((bestProfit / market.buyPrice) * 100);
                addLogMessage(`ヒント: ${good.name}は${bestSellCity}で${bestSellPrice}金貨で売れる可能性があります（利益${profitPercent}%）`);
            }
        }
        
        // 商品を販売
        function sellGoods(goodId, quantity) {
            const cargoItem = gameState.cargo.find(item => item.id === goodId);
            
            if (!cargoItem) {
                addLogMessage(`${goods.find(g => g.id === goodId).name}を所持していません。`);
                return;
            }
            
            if (cargoItem.quantity < quantity) {
                addLogMessage(`${cargoItem.name}の所持数が足りません。（所持数: ${cargoItem.quantity}）`);
                return;
            }
            
            const good = goods.find(g => g.id === goodId);
            const currentCityId = getCityIdByName(gameState.currentCity);
            const market = marketData[currentCityId][goodId];
            
            // 腐敗チェック
            let sellPrice = market.sellPrice;
            if (good.spoilage > 0 && cargoItem.daysHeld >= good.spoilage) {
                sellPrice = Math.round(sellPrice * 0.1); // 腐敗した場合は価格が大幅に下がる
                addLogMessage(`${cargoItem.name}は腐敗しているため、価格が大幅に下がっています。`);
            }
            
            const totalEarnings = sellPrice * quantity;
            const originalCost = cargoItem.purchasePrice * quantity;
            const profit = totalEarnings - originalCost;
            
            // 販売処理
            gameState.money += totalEarnings;
            cargoItem.quantity -= quantity;
            
            // 貨物容量を更新
            gameState.cargoCapacity -= good.weight * quantity;
            
            // 商品を完全に売り切った場合は配列から削除
            if (cargoItem.quantity <= 0) {
                gameState.cargo = gameState.cargo.filter(item => item.id !== goodId);
            }
            
            // 市場の在庫を増やす
            market.quantity += quantity;
            
            // UI更新
            updateUI();
            
            // ログに記録
            const profitPercent = Math.round((profit / originalCost) * 100);
            if (profit > 0) {
                addLogMessage(`${cargoItem.name}を${quantity}個、${totalEarnings}金貨で販売しました。利益: ${profit}金貨 (${profitPercent}%)`);
            } else if (profit < 0) {
                addLogMessage(`${cargoItem.name}を${quantity}個、${totalEarnings}金貨で販売しました。損失: ${Math.abs(profit)}金貨 (${profitPercent}%)`);
            } else {
                addLogMessage(`${cargoItem.name}を${quantity}個、${totalEarnings}金貨で販売しました。収支: 0`);
            }
        }
        
        // 都市間移動
        function travelToCity(cityId, days) {
            const targetCity = cities.find(c => c.id === cityId);
            if (!targetCity) return;
            
            // 日数経過処理
            for (let i = 0; i < days; i++) {
                advanceDay();
            }
            
            // 現在位置を更新
            gameState.currentCity = targetCity.name;
            
            // UI更新
            updateUI();
            
            // ログに記録
            addLogMessage(`${targetCity.name}に移動しました。（${days}日経過）`);
            
            // 売却可能な商品があれば提案
            const profitableGoods = [];
            
            gameState.cargo.forEach(item => {
                const good = goods.find(g => g.id === item.id);
                const cityMarket = marketData[cityId][item.id];
                const profit = (cityMarket.sellPrice * item.quantity) - (item.purchasePrice * item.quantity);
                
                if (profit > 0) {
                    const profitPercent = Math.round((profit / (item.purchasePrice * item.quantity)) * 100);
                    profitableGoods.push({
                        name: good.name,
                        profit: profit,
                        profitPercent: profitPercent
                    });
                }
            });
            
            if (profitableGoods.length > 0) {
                profitableGoods.sort((a, b) => b.profitPercent - a.profitPercent);
                
                let message = '売却可能な商品: ';
                profitableGoods.forEach((item, index) => {
                    if (index > 0) message += ', ';
                    message += `${item.name} (利益${item.profitPercent}%)`;
                });
                
                addLogMessage(message);
            }
        }
        
        // 次の日へ進む
        function advanceDay() {
            gameState.day += 1;
            
            // 食料の腐敗進行
            gameState.cargo.forEach(item => {
                const good = goods.find(g => g.id === item.id);
                if (good.spoilage > 0) {
                    item.daysHeld += 1;
                    
                    // 完全に腐敗した場合はログに記録
                    if (item.daysHeld === good.spoilage) {
                        addLogMessage(`${item.name}が腐敗しました。大幅に価値が下がります。`);
                    } else if (item.daysHeld === Math.floor(good.spoilage * 0.75)) {
                        addLogMessage(`${item.name}が劣化してきています。あと${good.spoilage - item.daysHeld}日で腐敗します。`);
                    }
                }
            });
            
            // 市場価格の変動
            updateMarkets();
            
            // UI更新
            updateUI();
        }
        
        // ログメッセージを追加
        function addLogMessage(message) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<strong>Day ${gameState.day}:</strong> ${message}`;
            gameLog.prepend(logEntry);
            
            // ログの最大表示数を制限
            while (gameLog.children.length > 100) {
                gameLog.removeChild(gameLog.lastChild);
            }
        }
        
        // UIを更新
        function updateUI() {
            dayDisplay.textContent = `日数: ${gameState.day}`;
            moneyDisplay.textContent = `所持金: ${gameState.money} 金貨`;
            locationDisplay.textContent = `現在地: ${gameState.currentCity}`;
            
            renderCities();
            renderMarket();
            renderCargo();
        }
        
        // ゲームを初期化
        function initGame() {
            gameState.day = 1;
            gameState.money = 1000;
            gameState.currentCity = "リスボン";
            gameState.cargoCapacity = 0;
            gameState.maxCargoCapacity = 100;
            gameState.cargo = [];
            gameState.logs = [];
            
            initializeMarkets();
            updateUI();
            
            // ゲーム開始ログ
            addLogMessage("ゲームを開始しました。リスボンから貿易を始めましょう！");
            addLogMessage("ワイン、塩、魚などの商品はリスボンで安く売られています。他の都市へ運ぶと利益が出ます！");
        }
        
        // 次の日へ進むボタンのイベントリスナー
        advanceDayBtn.addEventListener('click', () => {
            advanceDay();
            addLogMessage("1日が経過しました。");
        });
        
        // ゲームを初期化して開始
        initGame();
    </script>
</body>
</html>
