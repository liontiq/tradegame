<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è²¿æ˜“è‰¦éšŠã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .game-container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        h1, h2, h3 {
            color: #2c3e50;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .cities-container {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .city {
            flex: 1;
            min-width: 200px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 5px solid #3498db;
            margin-bottom: 10px;
        }
        
        .city-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #3498db;
            font-size: 18px;
        }
        
        .travel-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .travel-btn:hover {
            background-color: #2980b9;
        }
        
        .travel-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .market-container {
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .buy-btn, .sell-btn {
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .buy-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .buy-btn:hover {
            background-color: #27ae60;
        }
        
        .sell-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .sell-btn:hover {
            background-color: #c0392b;
        }
        
        .buy-btn:disabled, .sell-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .quantity-input {
            width: 50px;
            text-align: center;
        }
        
        .cargo-container {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        
        .cargo-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .spoil-warning {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .good-spoiled {
            color: #e74c3c;
            text-decoration: line-through;
        }
        
        .advance-day {
            background-color: #9b59b6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .advance-day:hover {
            background-color: #8e44ad;
        }
        
        .game-log {
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        
        .log-entry {
            margin: 5px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 10px 15px;
            background-color: #f0f0f0;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn.active {
            border-bottom: 2px solid #3498db;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 10px;
            background-color: #fff;
            border-top: 1px solid #ddd;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .price-up {
            color: green;
            font-weight: bold;
        }
        
        .price-down {
            color: red;
            font-weight: bold;
        }
        
        .city-specialty {
            margin-top: 10px;
            font-style: italic;
            color: #555;
        }
        
        .good-profit {
            background-color: #e6ffe6;
        }
        
        /* èˆ¹é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .ships-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        .ship-card {
            flex: 1;
            min-width: 200px;
            max-width: 300px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
            padding: 15px;
            position: relative;
        }
        
        .ship-card.active {
            border: 2px solid #3498db;
            background-color: #ebf5fb;
        }
        
        .ship-card h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .ship-detail {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .ship-detail-label {
            font-weight: bold;
            color: #555;
        }
        
        .select-ship-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .select-ship-btn:hover {
            background-color: #2980b9;
        }
        
        .ship-store-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        .ship-store-item h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .ship-store-details {
            margin: 10px 0;
        }
        
        .ship-store-price {
            font-weight: bold;
            color: #e74c3c;
            font-size: 18px;
            margin: 15px 0;
        }
        
        .buy-ship-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .buy-ship-btn:hover {
            background-color: #27ae60;
        }
        
        .buy-ship-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .ship-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
        }
        
        .fleet-summary {
            background-color: #f0f7fa;
            border: 1px solid #d6e9f5;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        .fleet-stat {
            display: inline-block;
            margin-right: 15px;
            font-weight: bold;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 768px) {
            .cities-container {
                flex-direction: column;
            }
            
            .city {
                margin-bottom: 15px;
            }
            
            .ship-card {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>è²¿æ˜“è‰¦éšŠã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
            <div class="stats">
                <div class="stat-item" id="day-display">æ—¥æ•°: 1</div>
                <div class="stat-item" id="money-display">æ‰€æŒé‡‘: 1000 é‡‘è²¨</div>
                <div class="stat-item" id="location-display">ç¾åœ¨åœ°: ãƒªã‚¹ãƒœãƒ³</div>
                <div class="stat-item" id="active-ship-display">ä½¿ç”¨ä¸­: å°å‹å•†èˆ¹</div>
            </div>
        </div>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="city-tab">éƒ½å¸‚ã¨ç§»å‹•</button>
                <button class="tab-btn" data-tab="market-tab">å¸‚å ´</button>
                <button class="tab-btn" data-tab="cargo-tab">æ‰€æŒå“</button>
                <button class="tab-btn" data-tab="ships-tab">èˆ¹å›£ç®¡ç†</button>
                <button class="tab-btn" data-tab="shipyard-tab">é€ èˆ¹æ‰€</button>
                <button class="tab-btn" data-tab="log-tab">ãƒ­ã‚°</button>
            </div>
            
            <div class="tab-content active" id="city-tab">
                <h2>åˆ©ç”¨å¯èƒ½ãªæ¸¯</h2>
                <div class="cities-container" id="cities-list">
                    <!-- éƒ½å¸‚ãƒªã‚¹ãƒˆã¯JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="tab-content" id="market-tab">
                <h2>å¸‚å ´ä¾¡æ ¼</h2>
                <div class="market-container">
                    <table id="market-table">
                        <thead>
                            <tr>
                                <th>å•†å“</th>
                                <th>ã‚«ãƒ†ã‚´ãƒª</th>
                                <th>è³¼å…¥ä¾¡æ ¼</th>
                                <th>è²©å£²ä¾¡æ ¼</th>
                                <th>åœ¨åº«æ•°</th>
                                <th>éœ€è¦</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="market-body">
                            <!-- å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã¯JSã§å‹•çš„ã«ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="cargo-tab">
                <h2>æ‰€æŒå“</h2>
                <div id="ship-cargo-selector"></div>
                <div class="cargo-container">
                    <table id="cargo-table">
                        <thead>
                            <tr>
                                <th>å•†å“</th>
                                <th>æ•°é‡</th>
                                <th>è³¼å…¥ä¾¡æ ¼</th>
                                <th>ç¾åœ¨ã®æ¨å®šä¾¡å€¤</th>
                                <th>çŠ¶æ…‹</th>
                                <th>åˆ©ç›Šäºˆæ¸¬</th>
                            </tr>
                        </thead>
                        <tbody id="cargo-body">
                            <!-- æ‰€æŒå“ãƒ‡ãƒ¼ã‚¿ã¯JSã§å‹•çš„ã«ç”Ÿæˆ -->
                        </tbody>
                    </table>
                    <p>è²¨ç‰©å®¹é‡: <span id="cargo-capacity">0</span> / <span id="max-cargo-capacity">100</span></p>
                </div>
            </div>
            
            <div class="tab-content" id="ships-tab">
                <h2>èˆ¹å›£ç®¡ç†</h2>
                <div class="fleet-summary" id="fleet-summary">
                    <!-- èˆ¹å›£ã‚µãƒãƒªãƒ¼ã¯JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
                <div class="ships-container" id="ships-container">
                    <!-- èˆ¹ã®ãƒªã‚¹ãƒˆã¯JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="tab-content" id="shipyard-tab">
                <h2>é€ èˆ¹æ‰€ - æ–°èˆ¹ã®è³¼å…¥</h2>
                <div id="shipyard-container">
                    <!-- èˆ¹ã®è³¼å…¥ãƒªã‚¹ãƒˆã¯JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="tab-content" id="log-tab">
                <h2>å–å¼•ãƒ­ã‚°</h2>
                <div class="game-log" id="game-log">
                    <!-- ãƒ­ã‚°ã¯JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <button class="advance-day" id="advance-day-btn">æ¬¡ã®æ—¥ã¸é€²ã‚€</button>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
        const gameState = {
            day: 1,
            money: 1000,
            currentCity: "ãƒªã‚¹ãƒœãƒ³",
            ships: [], // æ‰€æœ‰ã—ã¦ã„ã‚‹èˆ¹ã®ãƒªã‚¹ãƒˆ
            activeShipIndex: 0, // ç¾åœ¨ä½¿ç”¨ä¸­ã®èˆ¹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            logs: []
        };
        
        // èˆ¹ã®ãƒ‡ãƒ¼ã‚¿
        const shipTypes = [
            {
                id: "small_trader",
                name: "å°å‹å•†èˆ¹",
                description: "ä¸€èˆ¬çš„ãªè²¿æ˜“èˆ¹ã€‚åŸºæœ¬çš„ãªæ€§èƒ½ã‚’æŒã¤ã€‚",
                capacity: 100,
                speedFactor: 1.0, // åŸºæº–é€Ÿåº¦ï¼ˆå€¤ãŒå°ã•ã„ã»ã©é€Ÿã„ï¼‰
                cost: 1000, // åˆæœŸèˆ¹ãªã®ã§è¡¨ç¤ºç”¨
                durability: 100,
                icon: "â›µ"
            },
            {
                id: "medium_trader",
                name: "ä¸­å‹å•†èˆ¹",
                description: "ã‚ˆã‚Šå¤§ããªè²¨ç‰©å®¤ã‚’æŒã¤é ‘ä¸ˆãªèˆ¹ã€‚",
                capacity: 200,
                speedFactor: 0.9, // 10%é€Ÿã„
                cost: 3000,
                durability: 150,
                icon: "â›µ"
            },
            {
                id: "large_trader",
                name: "å¤§å‹å•†èˆ¹",
                description: "å¤§é‡ã®è²¨ç‰©ã‚’é‹ã¹ã‚‹å¤§å‹ã®è²¿æ˜“èˆ¹ã€‚",
                capacity: 300,
                speedFactor: 0.85, // 15%é€Ÿã„
                cost: 6000,
                durability: 200,
                icon: "ğŸš¢"
            },
            {
                id: "galleon",
                name: "ã‚¬ãƒ¬ã‚ªãƒ³èˆ¹",
                description: "è»äº‹ç”¨é€”ã‚‚å…¼ã­ãŸå¤§å‹å¸†èˆ¹ã€‚é€Ÿåº¦ã¨ç©è¼‰é‡ã«å„ªã‚Œã‚‹ã€‚",
                capacity: 400,
                speedFactor: 0.8, // 20%é€Ÿã„
                cost: 10000,
                durability: 250,
                icon: "ğŸš¢"
            },
            {
                id: "east_indiaman",
                name: "æ±ã‚¤ãƒ³ãƒ‰ä¼šç¤¾èˆ¹",
                description: "é•·è·é›¢èˆªæµ·ç”¨ã®å¤§å‹èˆ¹ã€‚æœ€é«˜ã®æ€§èƒ½ã‚’èª‡ã‚‹ã€‚",
                capacity: 500,
                speedFactor: 0.7, // 30%é€Ÿã„
                cost: 15000,
                durability: 300,
                icon: "ğŸš¢"
            }
        ];
        
        // éƒ½å¸‚ãƒ‡ãƒ¼ã‚¿
        const cities = [
            {
                id: "lisbon",
                name: "ãƒªã‚¹ãƒœãƒ³",
                description: "ãƒãƒ«ãƒˆã‚¬ãƒ«ã®é¦–éƒ½ã€‚ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã®ä¸­å¿ƒçš„è²¿æ˜“æ¸¯ã€‚",
                connections: ["london", "venice", "tunis"],
                travelDays: {"london": 5, "venice": 8, "tunis": 6}
            },
            {
                id: "london",
                name: "ãƒ­ãƒ³ãƒ‰ãƒ³",
                description: "ã‚¤ã‚®ãƒªã‚¹ã®é¦–éƒ½ã€‚æ¯›ç¹”ç‰©ã‚„å·¥èŠ¸å“ãŒè±Šå¯Œã€‚",
                connections: ["lisbon", "amsterdam"],
                travelDays: {"lisbon": 5, "amsterdam": 3}
            },
            {
                id: "venice",
                name: "ãƒ™ãƒãƒã‚¢",
                description: "åœ°ä¸­æµ·ã®å•†æ¥­å…±å’Œå›½ã€‚é¦™è¾›æ–™ã‚„çµ¹ã®å–å¼•ã§æ „ãˆã‚‹ã€‚",
                connections: ["lisbon", "alexandria", "istanbul"],
                travelDays: {"lisbon": 8, "alexandria": 7, "istanbul": 6}
            },
            {
                id: "amsterdam",
                name: "ã‚¢ãƒ ã‚¹ãƒ†ãƒ«ãƒ€ãƒ ",
                description: "ã‚ªãƒ©ãƒ³ãƒ€ã®å•†æ¥­ä¸­å¿ƒã€‚é‡‘èã¨é€ èˆ¹æ¥­ãŒç™ºé”ã€‚",
                connections: ["london", "hamburg"],
                travelDays: {"london": 3, "hamburg": 2}
            },
            {
                id: "alexandria",
                name: "ã‚¢ãƒ¬ã‚¯ã‚µãƒ³ãƒ‰ãƒªã‚¢",
                description: "ã‚¨ã‚¸ãƒ—ãƒˆã®æ¸¯ç”ºã€‚ã‚¢ãƒ•ãƒªã‚«ã‹ã‚‰ã®çã—ã„å•†å“ã®é›†æ•£åœ°ã€‚",
                connections: ["venice", "istanbul"],
                travelDays: {"venice": 7, "istanbul": 5}
            },
            {
                id: "istanbul",
                name: "ã‚¤ã‚¹ã‚¿ãƒ³ãƒ–ãƒ¼ãƒ«",
                description: "ã‚ªã‚¹ãƒãƒ³å¸å›½ã®é¦–éƒ½ã€‚æ±è¥¿ã®æ–‡åŒ–ãŒäº¤ã‚ã‚‹äº¤æ˜“æ‹ ç‚¹ã€‚",
                connections: ["venice", "alexandria"],
                travelDays: {"venice": 6, "alexandria": 5}
            },
            {
                id: "tunis",
                name: "ãƒãƒ¥ãƒ‹ã‚¹",
                description: "åŒ—ã‚¢ãƒ•ãƒªã‚«ã®æ¸¯ç”ºã€‚ç ‚ç³–ã¨é¦™æ–™ã®å–å¼•ãŒç››ã‚“ã€‚",
                connections: ["lisbon"],
                travelDays: {"lisbon": 6}
            },
            {
                id: "hamburg",
                name: "ãƒãƒ³ãƒ–ãƒ«ã‚¯",
                description: "ãƒ‰ã‚¤ãƒ„ã®è‡ªç”±éƒ½å¸‚ã€‚ãƒãƒ«ãƒˆæµ·è²¿æ˜“ã®æ‹ ç‚¹ã€‚",
                connections: ["amsterdam"],
                travelDays: {"amsterdam": 2}
            }
        ];
        
        // å•†å“ãƒ‡ãƒ¼ã‚¿
        const goods = [
            {
                id: "wheat",
                name: "å°éº¦",
                category: "é£Ÿæ–™",
                basePrice: 20,
                spoilage: 30, // ä½•æ—¥ã§è…ã‚‹ã‹
                volatility: 0.2, // ä¾¡æ ¼å¤‰å‹•ã®åº¦åˆã„
                baseQuantity: {min: 50, max: 100},
                weight: 1
            },
            {
                id: "fish",
                name: "é­š",
                category: "é£Ÿæ–™",
                basePrice: 30,
                spoilage: 5, // è…ã‚Šã‚„ã™ã„
                volatility: 0.3,
                baseQuantity: {min: 30, max: 80},
                weight: 1
            },
            {
                id: "meat",
                name: "è‚‰",
                category: "é£Ÿæ–™",
                basePrice: 50,
                spoilage: 8,
                volatility: 0.25,
                baseQuantity: {min: 20, max: 50},
                weight: 1
            },
            {
                id: "salt",
                name: "å¡©",
                category: "èª¿å‘³æ–™",
                basePrice: 40,
                spoilage: 0, // è…ã‚‰ãªã„
                volatility: 0.15,
                baseQuantity: {min: 30, max: 70},
                weight: 1
            },
            {
                id: "spices",
                name: "é¦™è¾›æ–™",
                category: "èª¿å‘³æ–™",
                basePrice: 80,
                spoilage: 60, // ã‚ã¾ã‚Šè…ã‚‰ãªã„
                volatility: 0.4,
                baseQuantity: {min: 10, max: 30},
                weight: 1
            },
            {
                id: "wine",
                name: "ãƒ¯ã‚¤ãƒ³",
                category: "é£²æ–™",
                basePrice: 60,
                spoilage: 90, // é•·æŒã¡ã™ã‚‹
                volatility: 0.2,
                baseQuantity: {min: 20, max: 60},
                weight: 2
            },
            {
                id: "cloth",
                name: "å¸ƒåœ°",
                category: "ç¹”ç‰©",
                basePrice: 70,
                spoilage: 0, // è…ã‚‰ãªã„
                volatility: 0.2,
                baseQuantity: {min: 20, max: 50},
                weight: 2
            },
            {
                id: "silk",
                name: "çµ¹",
                category: "ç¹”ç‰©",
                basePrice: 150,
                spoilage: 0, // è…ã‚‰ãªã„
                volatility: 0.3,
                baseQuantity: {min: 5, max: 25},
                weight: 1
            },
            {
                id: "timber",
                name: "æœ¨æ",
                category: "è³‡æ",
                basePrice: 45,
                spoilage: 0, // è…ã‚‰ãªã„
                volatility: 0.1,
                baseQuantity: {min: 30, max: 80},
                weight: 3
            },
            {
                id: "metals",
                name: "é‡‘å±",
                category: "è³‡æ",
                basePrice: 90,
                spoilage: 0, // è…ã‚‰ãªã„
                volatility: 0.15,
                baseQuantity: {min: 15, max: 40},
                weight: 4
            },
            {
                id: "jewelry",
                name: "å®é£¾å“",
                category: "è´…æ²¢å“",
                basePrice: 200,
                spoilage: 0, // è…ã‚‰ãªã„
                volatility: 0.4,
                baseQuantity: {min: 3, max: 15},
                weight: 1
            },
            {
                id: "pottery",
                name: "é™¶å™¨",
                category: "å·¥èŠ¸å“",
                basePrice: 55,
                spoilage: 0, // è…ã‚‰ãªã„
                volatility: 0.2,
                baseQuantity: {min: 15, max: 45},
                weight: 2
            }
        ];
        
        // éƒ½å¸‚ã”ã¨ã®å•†å“ç‰¹æ€§ï¼ˆéœ€è¦ã¨ä¾›çµ¦ï¼‰
        const cityGoodsTrait = {
            "lisbon": {
                high_supply: ["wine", "salt", "fish"],
                high_demand: ["silk", "spices", "jewelry"]
            },
            "london": {
                high_supply: ["cloth", "metals", "fish"],
                high_demand: ["wine", "spices", "timber"]
            },
            "venice": {
                high_supply: ["silk", "pottery", "jewelry"],
                high_demand: ["metals", "timber", "wheat"]
            },
            "amsterdam": {
                high_supply: ["cloth", "pottery", "fish"],
                high_demand: ["wine", "silk", "spices"]
            },
            "alexandria": {
                high_supply: ["spices", "wheat", "pottery"],
                high_demand: ["metals", "cloth", "wine"]
            },
            "istanbul": {
                high_supply: ["spices", "silk", "jewelry"],
                high_demand: ["metals", "timber", "salt"]
            },
            "tunis": {
                high_supply: ["spices", "salt", "wheat"],
                high_demand: ["cloth", "metals", "pottery"]
            },
            "hamburg": {
                high_supply: ["timber", "metals", "fish"],
                high_demand: ["silk", "spices", "jewelry"]
            }
        };
        
        // å¸‚å ´ãƒ‡ãƒ¼ã‚¿ï¼ˆéƒ½å¸‚ã”ã¨ã®åœ¨åº«ã¨ä¾¡æ ¼ï¼‰
        let marketData = {};
        
        // å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
        function initializeMarkets() {
            cities.forEach(city => {
                marketData[city.id] = {};
                
                goods.forEach(good => {
                    // éœ€è¦ã¨ä¾›çµ¦ã®ä¿®é£¾å­ã‚’æ±ºå®š
                    let demandModifier = 1.0;
                    let supplyModifier = 1.0;
                    
                    // é«˜éœ€è¦å•†å“ã®å ´åˆ
                    if (cityGoodsTrait[city.id].high_demand.includes(good.id)) {
                        demandModifier = 2.0; // ä¾¡æ ¼ä¸Šæ˜‡
                        supplyModifier = 0.6; // åœ¨åº«æ¸›å°‘
                    }
                    
                    // é«˜ä¾›çµ¦å•†å“ã®å ´åˆ
                    if (cityGoodsTrait[city.id].high_supply.includes(good.id)) {
                        demandModifier = 0.5; // ä¾¡æ ¼ä½ä¸‹
                        supplyModifier = 1.8; // åœ¨åº«å¢—åŠ 
                    }
                    
                    // ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã‚’åŠ ãˆã‚‹
                    const randomDemand = 0.8 + Math.random() * 0.4; // 0.8-1.2
                    const randomSupply = 0.8 + Math.random() * 0.4; // 0.8-1.2
                    
                    // ä¾¡æ ¼è¨ˆç®—
                    const basePrice = good.basePrice;
                    const buyPrice = Math.round(basePrice * demandModifier * randomDemand);
                    
                    // è²©å£²ä¾¡æ ¼ã¯è³¼å…¥ä¾¡æ ¼ã®85%
                    const sellPrice = Math.round(buyPrice * 0.85);
                    
                    // åœ¨åº«è¨ˆç®—
                    const minQuantity = good.baseQuantity.min;
                    const maxQuantity = good.baseQuantity.max;
                    const quantity = Math.round((minQuantity + Math.random() * (maxQuantity - minQuantity)) * supplyModifier * randomSupply);
                    
                    // éœ€è¦åº¦ï¼ˆ0-10ï¼‰
                    const demand = Math.round(demandModifier * randomDemand * 5);
                    
                    marketData[city.id][good.id] = {
                        buyPrice: buyPrice,
                        sellPrice: sellPrice,
                        quantity: quantity,
                        demand: demand
                    };
                });
            });
        }
        
        // å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆæ—¥æ•°çµŒéæ™‚ï¼‰
        function updateMarkets() {
            cities.forEach(city => {
                goods.forEach(good => {
                    const market = marketData[city.id][good.id];
                    
                    // åŸºæœ¬çš„ãªéœ€è¦ã¨ä¾›çµ¦ã®ä¿®é£¾å­
                    let demandModifier = 1.0;
                    let supplyModifier = 1.0;
                    
                    // é«˜éœ€è¦å•†å“ã®å ´åˆ
                    if (cityGoodsTrait[city.id].high_demand.includes(good.id)) {
                        demandModifier = 1.5;
                        supplyModifier = 0.8;
                    }
                    
                    // é«˜ä¾›çµ¦å•†å“ã®å ´åˆ
                    if (cityGoodsTrait[city.id].high_supply.includes(good.id)) {
                        demandModifier = 0.8;
                        supplyModifier = 1.3;
                    }
                    
                    // ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ 
                    const randomFactor = 0.9 + Math.random() * 0.2; // 0.9-1.1
                    
                    // åœ¨åº«ãŒå°‘ãªã„å ´åˆã€éœ€è¦å¢—åŠ ãƒ»ä¾¡æ ¼ä¸Šæ˜‡
                    const quantityFactor = Math.max(0.5, Math.min(1.5, 1 + (good.baseQuantity.max / 2 - market.quantity) / (good.baseQuantity.max / 2)));
                    
                    // ä¾¡æ ¼æ›´æ–°
                    const volatilityFactor = 1 + (Math.random() * 2 - 1) * good.volatility;
                    const newBuyPrice = Math.round(market.buyPrice * randomFactor * volatilityFactor * (1 + (quantityFactor - 1) * 0.5));
                    market.buyPrice = Math.max(Math.round(good.basePrice * 0.5), Math.min(Math.round(good.basePrice * 3.0), newBuyPrice));
                    market.sellPrice = Math.round(market.buyPrice * 0.85);
                    
                    // åœ¨åº«æ›´æ–°ï¼ˆåŸºæœ¬çš„ã«å…ƒã«æˆ»ã‚‹å‚¾å‘ï¼‰
                    const baseStockLevel = (good.baseQuantity.min + good.baseQuantity.max) / 2 * supplyModifier;
                    const restockRate = 0.2; // 20%ã®é€Ÿåº¦ã§ç†æƒ³åœ¨åº«ã«è¿‘ã¥ã
                    const restockAmount = Math.round((baseStockLevel - market.quantity) * restockRate);
                    market.quantity = Math.max(0, market.quantity + restockAmount);
                    
                    // éœ€è¦æ›´æ–°
                    market.demand = Math.round(Math.max(1, Math.min(10, market.demand * randomFactor * demandModifier)));
                });
            });
        }
        
        // UIè¦ç´ ã®å‚ç…§ã‚’å–å¾—
        const dayDisplay = document.getElementById('day-display');
        const moneyDisplay = document.getElementById('money-display');
        const locationDisplay = document.getElementById('location-display');
        const activeShipDisplay = document.getElementById('active-ship-display');
        const citiesList = document.getElementById('cities-list');
        const marketBody = document.getElementById('market-body');
        const cargoBody = document.getElementById('cargo-body');
        const cargoCapacity = document.getElementById('cargo-capacity');
        const maxCargoCapacity = document.getElementById('max-cargo-capacity');
        const advanceDayBtn = document.getElementById('advance-day-btn');
        const gameLog = document.getElementById('game-log');
        const shipsContainer = document.getElementById('ships-container');
        const shipyardContainer = document.getElementById('shipyard-container');
        const fleetSummary = document.getElementById('fleet-summary');
        const shipCargoSelector = document.getElementById('ship-cargo-selector');
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                button.classList.add('active');
                
                // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«å¯¾å¿œã™ã‚‹ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // èˆ¹ã‚’ä½œæˆã™ã‚‹é–¢æ•°
        function createShip(typeId) {
            const shipType = shipTypes.find(type => type.id === typeId);
            if (!shipType) return null;
            
            return {
                typeId: typeId,
                name: shipType.name,
                capacity: shipType.capacity,
                speedFactor: shipType.speedFactor,
                durability: shipType.durability,
                currentCapacity: 0,
                cargo: []
            };
        }
        
        // ç¾åœ¨é¸æŠä¸­ã®èˆ¹ã‚’å–å¾—
        function getActiveShip() {
            return gameState.ships[gameState.activeShipIndex];
        }
        
        // éƒ½å¸‚ãƒªã‚¹ãƒˆã‚’æç”»
        function renderCities() {
            citiesList.innerHTML = '';
            
            cities.forEach(city => {
                const cityElement = document.createElement('div');
                cityElement.className = 'city';
                
                const isCurrentCity = city.id === getCityIdByName(gameState.currentCity);
                
                let specialties = '';
                if (cityGoodsTrait[city.id].high_supply.length > 0) {
                    const supplyNames = cityGoodsTrait[city.id].high_supply.map(id => {
                        const good = goods.find(g => g.id === id);
                        return good ? good.name : '';
                    }).join('ã€');
                    specialties += `<div class="city-specialty">ä¾›çµ¦: ${supplyNames}</div>`;
                }
                
                if (cityGoodsTrait[city.id].high_demand.length > 0) {
                    const demandNames = cityGoodsTrait[city.id].high_demand.map(id => {
                        const good = goods.find(g => g.id === id);
                        return good ? good.name : '';
                    }).join('ã€');
                    specialties += `<div class="city-specialty">éœ€è¦: ${demandNames}</div>`;
                }
                
                let cityHTML = `
                    <div class="city-name">${city.name}</div>
                    <div>${city.description}</div>
                    ${specialties}
                `;
                
                if (!isCurrentCity) {
                    const currentCityId = getCityIdByName(gameState.currentCity);
                    const currentCity = cities.find(c => c.id === currentCityId);
                    
                    if (currentCity.connections.includes(city.id)) {
                        const baseTravel = currentCity.travelDays[city.id];
                        const activeShip = getActiveShip();
                        const adjustedTravel = Math.max(1, Math.ceil(baseTravel * activeShip.speedFactor));
                        
                        cityHTML += `
                            <button class="travel-btn" data-city="${city.id}" data-days="${adjustedTravel}">
                                ç§»å‹•ã™ã‚‹ï¼ˆ${adjustedTravel}æ—¥ï¼‰
                            </button>
                        `;
                    }
                } else {
                    cityHTML += `<div><strong>ç¾åœ¨ä½ç½®</strong></div>`;
                }
                
                cityElement.innerHTML = cityHTML;
                citiesList.appendChild(cityElement);
            });
            
            // ç§»å‹•ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.travel-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const cityId = button.getAttribute('data-city');
                    const days = parseInt(button.getAttribute('data-days'));
                    travelToCity(cityId, days);
                });
            });
        }
        
        // å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚’æç”»
        function renderMarket() {
            marketBody.innerHTML = '';
            
            const currentCityId = getCityIdByName(gameState.currentCity);
            const activeShip = getActiveShip();
            
            goods.forEach(good => {
                const market = marketData[currentCityId][good.id];
                
                const tr = document.createElement('tr');
                
                // é«˜éœ€è¦/é«˜ä¾›çµ¦ã«åŸºã¥ã„ã¦è¡Œã®è‰²ã‚’å¤‰ãˆã‚‹
                if (cityGoodsTrait[currentCityId].high_supply.includes(good.id)) {
                    tr.classList.add('good-profit'); // å®‰ãè²·ãˆã‚‹å•†å“
                }
                
                // éœ€è¦ã«å¿œã˜ãŸè¡¨ç¤ºï¼ˆâ˜…ã®æ•°ï¼‰
                let demandDisplay = '';
                for (let i = 0; i < market.demand; i++) {
                    demandDisplay += 'â˜…';
                }
                
                // ä»–éƒ½å¸‚ã§ã®ä¾¡æ ¼ã‚’ç¢ºèªã—ã¦å£²å´å€™è£œã‹ã©ã†ã‹åˆ¤æ–­
                let bestSellCity = '';
                let bestSellPrice = 0;
                
                cities.forEach(city => {
                    if (city.id !== currentCityId) {
                        const cityMarket = marketData[city.id][good.id];
                        if (cityMarket.sellPrice > bestSellPrice) {
                            bestSellPrice = cityMarket.sellPrice;
                            bestSellCity = city.name;
                        }
                    }
                });
                
                // è²©å£²ä¾¡æ ¼ã®è‰²ã‚’æ±ºå®šï¼ˆç¾åœ¨ã®éƒ½å¸‚ã‚ˆã‚Šé«˜ã„å ´åˆã¯ç·‘ã€ä½ã„å ´åˆã¯èµ¤ï¼‰
                const priceClass = bestSellPrice > market.sellPrice ? 'price-up' : 'price-down';
                
                let priceInfo = '';
                if (bestSellCity) {
                    const priceDiff = bestSellPrice - market.buyPrice;
                    const profitPercent = Math.round((priceDiff / market.buyPrice) * 100);
                    priceInfo = `<div class="${priceClass}">æœ€é«˜å£²å´: ${bestSellCity} (${bestSellPrice}é‡‘è²¨ã€åˆ©ç›Š${profitPercent}%)</div>`;
                }
                
                // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹ã‚’ç¢ºèª
                const canBuy = activeShip.currentCapacity + good.weight <= activeShip.capacity;
                const canSell = activeShip.cargo.some(item => item.id === good.id);
                
                tr.innerHTML = `
                    <td>${good.name}</td>
                    <td>${good.category}</td>
                    <td>${market.buyPrice} é‡‘è²¨ ${priceInfo}</td>
                    <td>${market.sellPrice} é‡‘è²¨</td>
                    <td>${market.quantity}</td>
                    <td>${demandDisplay}</td>
                    <td class="action-buttons">
                        <input type="number" class="quantity-input" min="1" max="10" value="1">
                        <button class="buy-btn" data-good="${good.id}" ${canBuy ? '' : 'disabled'}>è³¼å…¥</button>
                        <button class="sell-btn" data-good="${good.id}" ${canSell ? '' : 'disabled'}>è²©å£²</button>
                    </td>
                `;
                
                marketBody.appendChild(tr);
            });
            
            // è³¼å…¥ãƒ»è²©å£²ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.buy-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const goodId = button.getAttribute('data-good');
                    const quantityInput = button.parentElement.querySelector('.quantity-input');
                    const quantity = parseInt(quantityInput.value);
                    buyGoods(goodId, quantity);
                });
            });
            
            document.querySelectorAll('.sell-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const goodId = button.getAttribute('data-good');
                    const quantityInput = button.parentElement.querySelector('.quantity-input');
                    const quantity = parseInt(quantityInput.value);
                    sellGoods(goodId, quantity);
                });
            });
        }
        
        // èˆ¹ã®è²¨ç‰©é¸æŠUIã‚’æç”»
        function renderShipCargoSelector() {
            if (gameState.ships.length <= 1) {
                shipCargoSelector.innerHTML = '';
                return;
            }
            
            let html = '<div style="margin-bottom: 15px;"><label>èˆ¹ã‚’é¸æŠ: </label><select id="cargo-ship-selector">';
            
            gameState.ships.forEach((ship, index) => {
                html += `<option value="${index}" ${index === gameState.activeShipIndex ? 'selected' : ''}>${ship.name} (${ship.currentCapacity}/${ship.capacity})</option>`;
            });
            
            html += '</select></div>';
            
            shipCargoSelector.innerHTML = html;
            
            // èˆ¹é¸æŠã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.getElementById('cargo-ship-selector').addEventListener('change', function() {
                const selectedIndex = parseInt(this.value);
                gameState.activeShipIndex = selectedIndex;
                updateUI();
            });
        }
        
        // æ‰€æŒå“ã‚’æç”»
        function renderCargo() {
            renderShipCargoSelector();
            
            cargoBody.innerHTML = '';
            
            const activeShip = getActiveShip();
            
            if (activeShip.cargo.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" style="text-align: center;">æ‰€æŒå“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td>';
                cargoBody.appendChild(tr);
            } else {
                activeShip.cargo.forEach(item => {
                    const good = goods.find(g => g.id === item.id);
                    const currentCityId = getCityIdByName(gameState.currentCity);
                    const currentMarketPrice = marketData[currentCityId][item.id].sellPrice;
                    const currentValue = currentMarketPrice * item.quantity;
                    const purchaseValue = item.purchasePrice * item.quantity;
                    const profit = currentValue - purchaseValue;
                    
                    // è…æ•—åº¦ã®è¨ˆç®—
                    let spoilageStatus = '';
                    if (good.spoilage > 0) {
                        const spoilagePercent = Math.round(item.daysHeld / good.spoilage * 100);
                        if (spoilagePercent >= 100) {
                            spoilageStatus = '<span class="good-spoiled">è…æ•—</span>';
                        } else if (spoilagePercent >= 75) {
                            spoilageStatus = '<span class="spoil-warning">å±é™º (ã‚ã¨' + (good.spoilage - item.daysHeld) + 'æ—¥)</span>';
                        } else if (spoilagePercent >= 50) {
                            spoilageStatus = 'åŠ£åŒ–ä¸­ (ã‚ã¨' + (good.spoilage - item.daysHeld) + 'æ—¥)';
                        } else {
                            spoilageStatus = 'è‰¯å¥½ (ã‚ã¨' + (good.spoilage - item.daysHeld) + 'æ—¥)';
                        }
                    } else {
                        spoilageStatus = 'å¤‰åŒ–ãªã—';
                    }
                    
                    // æœ€ã‚‚åˆ©ç›Šã®å‡ºã‚‹éƒ½å¸‚ã‚’æ¢ã™
                    let bestCity = '';
                    let bestProfit = profit;
                    
                    cities.forEach(city => {
                        if (city.id !== currentCityId) {
                            const cityMarket = marketData[city.id][item.id];
                            const cityProfit = (cityMarket.sellPrice * item.quantity) - purchaseValue;
                            if (cityProfit > bestProfit) {
                                bestProfit = cityProfit;
                                bestCity = city.name;
                            }
                        }
                    });
                    
                    let profitInfo = '';
                    if (bestCity && bestProfit > profit) {
                        const profitPercent = Math.round((bestProfit / purchaseValue) * 100);
                        profitInfo = `${bestCity}ã§å£²ã‚Œã°${bestProfit}é‡‘è²¨ã®åˆ©ç›Š (${profitPercent}%)`;
                    } else {
                        const profitPercent = Math.round((profit / purchaseValue) * 100);
                        profitInfo = `ç¾åœ¨åœ°ã§${profit}é‡‘è²¨ã®åˆ©ç›Š (${profitPercent}%)`;
                    }
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${good.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.purchasePrice} é‡‘è²¨</td>
                        <td>${currentMarketPrice} é‡‘è²¨ <span style="color: ${profit >= 0 ? 'green' : 'red'};">(${profit >= 0 ? '+' : ''}${profit})</span></td>
                        <td>${spoilageStatus}</td>
                        <td>${profitInfo}</td>
                    `;
                    
                    cargoBody.appendChild(tr);
                });
            }
            
            // è²¨ç‰©å®¹é‡ã®è¡¨ç¤ºæ›´æ–°
            cargoCapacity.textContent = activeShip.currentCapacity;
            maxCargoCapacity.textContent = activeShip.capacity;
        }
        
        // èˆ¹å›£ç®¡ç†ç”»é¢ã‚’æç”»
        function renderShips() {
            shipsContainer.innerHTML = '';
            
            // è‰¦éšŠã‚µãƒãƒªãƒ¼
            const totalShips = gameState.ships.length;
            const totalCapacity = gameState.ships.reduce((sum, ship) => sum + ship.capacity, 0);
            const usedCapacity = gameState.ships.reduce((sum, ship) => sum + ship.currentCapacity, 0);
            
            fleetSummary.innerHTML = `
                <div class="fleet-stat">æ‰€æœ‰èˆ¹èˆ¶æ•°: ${totalShips} éš»</div>
                <div class="fleet-stat">ç·è²¨ç‰©å®¹é‡: ${usedCapacity}/${totalCapacity}</div>
                <div class="fleet-stat">ç¾åœ¨åœ°: ${gameState.currentCity}</div>
            `;
            
            // å„èˆ¹ã®æƒ…å ±
            gameState.ships.forEach((ship, index) => {
                const shipType = shipTypes.find(type => type.id === ship.typeId);
                const isActive = index === gameState.activeShipIndex;
                
                const shipCard = document.createElement('div');
                shipCard.className = `ship-card ${isActive ? 'active' : ''}`;
                
                shipCard.innerHTML = `
                    <div class="ship-icon">${shipType.icon}</div>
                    <h3>${ship.name}</h3>
                    <div class="ship-detail">
                        <span class="ship-detail-label">è²¨ç‰©å®¹é‡:</span>
                        <span>${ship.currentCapacity}/${ship.capacity}</span>
                    </div>
                    <div class="ship-detail">
                        <span class="ship-detail-label">é€Ÿåº¦ä¿‚æ•°:</span>
                        <span>${ship.speedFactor.toFixed(2)} (${Math.round((1 - ship.speedFactor) * 100)}% é€Ÿã„)</span>
                    </div>
                    <div class="ship-detail">
                        <span class="ship-detail-label">è€ä¹…æ€§:</span>
                        <span>${ship.durability}/${shipType.durability}</span>
                    </div>
                    <div class="ship-detail">
                        <span class="ship-detail-label">ç©è¼‰å•†å“æ•°:</span>
                        <span>${ship.cargo.length}ç¨®é¡</span>
                    </div>
                    ${!isActive ? `<button class="select-ship-btn" data-ship-index="${index}">ã“ã®èˆ¹ã‚’ä½¿ç”¨</button>` : '<div style="margin-top: 10px;"><strong>ç¾åœ¨ä½¿ç”¨ä¸­</strong></div>'}
                `;
                
                shipsContainer.appendChild(shipCard);
            });
            
            // èˆ¹é¸æŠãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.select-ship-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const shipIndex = parseInt(button.getAttribute('data-ship-index'));
                    gameState.activeShipIndex = shipIndex;
                    updateUI();
                    addLogMessage(`${gameState.ships[shipIndex].name}ã‚’ä½¿ç”¨ä¸­ã®èˆ¹ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
                });
            });
        }
        
        // é€ èˆ¹æ‰€ç”»é¢ã‚’æç”»
        function renderShipyard() {
            shipyardContainer.innerHTML = '';
            
            // è³¼å…¥å¯èƒ½ãªèˆ¹ã®ãƒªã‚¹ãƒˆï¼ˆæœ€åˆã®èˆ¹ã¯é™¤ãï¼‰
            const purchasableShips = shipTypes.slice(1);
            
            purchasableShips.forEach(shipType => {
                const shipItem = document.createElement('div');
                shipItem.className = 'ship-store-item';
                
                // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹ã‚’ç¢ºèª
                const canBuy = gameState.money >= shipType.cost;
                
                shipItem.innerHTML = `
                    <h3>${shipType.name} ${shipType.icon}</h3>
                    <div class="ship-store-details">${shipType.description}</div>
                    <div class="ship-store-details">
                        <strong>è²¨ç‰©å®¹é‡:</strong> ${shipType.capacity} |
                        <strong>é€Ÿåº¦:</strong> ${Math.round((1 - shipType.speedFactor) * 100)}%å¢—åŠ  |
                        <strong>è€ä¹…æ€§:</strong> ${shipType.durability}
                    </div>
                    <div class="ship-store-price">${shipType.cost} é‡‘è²¨</div>
                    <button class="buy-ship-btn" data-ship-type="${shipType.id}" ${canBuy ? '' : 'disabled'}>è³¼å…¥ã™ã‚‹</button>
                `;
                
                shipyardContainer.appendChild(shipItem);
            });
            
            // è³¼å…¥ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.buy-ship-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const shipTypeId = button.getAttribute('data-ship-type');
                    buyShip(shipTypeId);
                });
            });
        }
        
        // èˆ¹ã‚’è³¼å…¥ã™ã‚‹
        function buyShip(shipTypeId) {
            const shipType = shipTypes.find(type => type.id === shipTypeId);
            if (!shipType) return;
            
            if (gameState.money < shipType.cost) {
                addLogMessage(`${shipType.name}ã‚’è³¼å…¥ã™ã‚‹ã®ã«å¿…è¦ãªè³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚`);
                return;
            }
            
            // èˆ¹ã‚’ä½œæˆ
            const newShip = createShip(shipTypeId);
            
            // è³¼å…¥å‡¦ç†
            gameState.money -= shipType.cost;
            gameState.ships.push(newShip);
            
            // UIæ›´æ–°
            updateUI();
            
            // ãƒ­ã‚°ã«è¨˜éŒ²
            addLogMessage(`${shipType.name}ã‚’${shipType.cost}é‡‘è²¨ã§è³¼å…¥ã—ã¾ã—ãŸï¼èˆ¹å›£ã«åŠ ã‚ã‚Šã¾ã—ãŸã€‚`);
        }
        
        // éƒ½å¸‚åã‹ã‚‰IDã‚’å–å¾—
        function getCityIdByName(cityName) {
            const city = cities.find(c => c.name === cityName);
            return city ? city.id : null;
        }
        
        // éƒ½å¸‚IDã‹ã‚‰åå‰ã‚’å–å¾—
        function getCityNameById(cityId) {
            const city = cities.find(c => c.id === cityId);
            return city ? city.name : null;
        }
        
        // å•†å“ã‚’è³¼å…¥
        function buyGoods(goodId, quantity) {
            const currentCityId = getCityIdByName(gameState.currentCity);
            const market = marketData[currentCityId][goodId];
            const good = goods.find(g => g.id === goodId);
            const activeShip = getActiveShip();
            
            if (!market || !good) return;
            
            // åœ¨åº«ç¢ºèª
            if (market.quantity < quantity) {
                addLogMessage(`${good.name}ã®åœ¨åº«ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚ï¼ˆåœ¨åº«: ${market.quantity}ï¼‰`);
                return;
            }
            
            // è²¨ç‰©å®¹é‡ç¢ºèª
            const requiredCapacity = good.weight * quantity;
            if (activeShip.currentCapacity + requiredCapacity > activeShip.capacity) {
                addLogMessage(`${activeShip.name}ã®è²¨ç‰©å®¹é‡ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚å¿…è¦å®¹é‡: ${requiredCapacity}ã€æ®‹ã‚Šå®¹é‡: ${activeShip.capacity - activeShip.currentCapacity}`);
                return;
            }
            
            // æ‰€æŒé‡‘ç¢ºèª
            const totalCost = market.buyPrice * quantity;
            if (gameState.money < totalCost) {
                addLogMessage(`æ‰€æŒé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚å¿…è¦é‡‘é¡: ${totalCost}é‡‘è²¨ã€æ‰€æŒé‡‘: ${gameState.money}é‡‘è²¨`);
                return;
            }
            
            // è³¼å…¥å‡¦ç†
            gameState.money -= totalCost;
            market.quantity -= quantity;
            
            // æ—¢ã«æ‰€æŒã—ã¦ã„ã‚‹å ´åˆã¯æ•°é‡ã‚’è¿½åŠ 
            const existingItem = activeShip.cargo.find(item => item.id === goodId);
            if (existingItem) {
                // å¹³å‡è³¼å…¥ä¾¡æ ¼ã‚’è¨ˆç®—
                const totalOldValue = existingItem.purchasePrice * existingItem.quantity;
                const totalNewValue = market.buyPrice * quantity;
                const totalQuantity = existingItem.quantity + quantity;
                const averagePrice = Math.round((totalOldValue + totalNewValue) / totalQuantity);
                
                existingItem.quantity += quantity;
                existingItem.purchasePrice = averagePrice;
            } else {
                // æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦è¿½åŠ 
                activeShip.cargo.push({
                    id: goodId,
                    name: good.name,
                    quantity: quantity,
                    purchasePrice: market.buyPrice,
                    daysHeld: 0
                });
            }
            
            // è²¨ç‰©å®¹é‡ã‚’æ›´æ–°
            activeShip.currentCapacity += requiredCapacity;
            
            // UIæ›´æ–°
            updateUI();
            
            // ãƒ­ã‚°ã«è¨˜éŒ²
            addLogMessage(`${good.name}ã‚’${quantity}å€‹ã€${totalCost}é‡‘è²¨ã§è³¼å…¥ã—ã¾ã—ãŸã€‚ï¼ˆ${activeShip.name}ã«ç©è¼‰ï¼‰`);
            
            // å£²å´å¯èƒ½ãªéƒ½å¸‚ã‚’ææ¡ˆ
            let bestSellCity = '';
            let bestSellPrice = 0;
            let bestProfit = 0;
            
            cities.forEach(city => {
                if (city.id !== currentCityId) {
                    const cityMarket = marketData[city.id][goodId];
                    const profit = cityMarket.sellPrice - market.buyPrice;
                    if (profit > bestProfit) {
                        bestProfit = profit;
                        bestSellPrice = cityMarket.sellPrice;
                        bestSellCity = city.name;
                    }
                }
            });
            
            if (bestSellCity && bestProfit > 0) {
                const profitPercent = Math.round((bestProfit / market.buyPrice) * 100);
                addLogMessage(`ãƒ’ãƒ³ãƒˆ: ${good.name}ã¯${bestSellCity}ã§${bestSellPrice}é‡‘è²¨ã§å£²ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆåˆ©ç›Š${profitPercent}%ï¼‰`);
            }
        }
        
        // å•†å“ã‚’è²©å£²
        function sellGoods(goodId, quantity) {
            const activeShip = getActiveShip();
            const cargoItem = activeShip.cargo.find(item => item.id === goodId);
            
            if (!cargoItem) {
                addLogMessage(`${goods.find(g => g.id === goodId).name}ã‚’æ‰€æŒã—ã¦ã„ã¾ã›ã‚“ã€‚`);
                return;
            }
            
            if (cargoItem.quantity < quantity) {
                addLogMessage(`${cargoItem.name}ã®æ‰€æŒæ•°ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚ï¼ˆæ‰€æŒæ•°: ${cargoItem.quantity}ï¼‰`);
                return;
            }
            
            const good = goods.find(g => g.id === goodId);
            const currentCityId = getCityIdByName(gameState.currentCity);
            const market = marketData[currentCityId][goodId];
            
            // è…æ•—ãƒã‚§ãƒƒã‚¯
            let sellPrice = market.sellPrice;
            if (good.spoilage > 0 && cargoItem.daysHeld >= good.spoilage) {
                sellPrice = Math.round(sellPrice * 0.1); // è…æ•—ã—ãŸå ´åˆã¯ä¾¡æ ¼ãŒå¤§å¹…ã«ä¸‹ãŒã‚‹
                addLogMessage(`${cargoItem.name}ã¯è…æ•—ã—ã¦ã„ã‚‹ãŸã‚ã€ä¾¡æ ¼ãŒå¤§å¹…ã«ä¸‹ãŒã£ã¦ã„ã¾ã™ã€‚`);
            }
            
            const totalEarnings = sellPrice * quantity;
            const originalCost = cargoItem.purchasePrice * quantity;
            const profit = totalEarnings - originalCost;
            
            // è²©å£²å‡¦ç†
            gameState.money += totalEarnings;
            cargoItem.quantity -= quantity;
            
            // è²¨ç‰©å®¹é‡ã‚’æ›´æ–°
            activeShip.currentCapacity -= good.weight * quantity;
            
            // å•†å“ã‚’å®Œå…¨ã«å£²ã‚Šåˆ‡ã£ãŸå ´åˆã¯é…åˆ—ã‹ã‚‰å‰Šé™¤
            if (cargoItem.quantity <= 0) {
                activeShip.cargo = activeShip.cargo.filter(item => item.id !== goodId);
            }
            
            // å¸‚å ´ã®åœ¨åº«ã‚’å¢—ã‚„ã™
            market.quantity += quantity;
            
            // UIæ›´æ–°
            updateUI();
            
            // ãƒ­ã‚°ã«è¨˜éŒ²
            const profitPercent = Math.round((profit / originalCost) * 100);
            if (profit > 0) {
                addLogMessage(`${cargoItem.name}ã‚’${quantity}å€‹ã€${totalEarnings}é‡‘è²¨ã§è²©å£²ã—ã¾ã—ãŸã€‚åˆ©ç›Š: ${profit}é‡‘è²¨ (${profitPercent}%)`);
            } else if (profit < 0) {
                addLogMessage(`${cargoItem.name}ã‚’${quantity}å€‹ã€${totalEarnings}é‡‘è²¨ã§è²©å£²ã—ã¾ã—ãŸã€‚æå¤±: ${Math.abs(profit)}é‡‘è²¨ (${profitPercent}%)`);
            } else {
                addLogMessage(`${cargoItem.name}ã‚’${quantity}å€‹ã€${totalEarnings}é‡‘è²¨ã§è²©å£²ã—ã¾ã—ãŸã€‚åæ”¯: 0`);
            }
        }
        
        // éƒ½å¸‚é–“ç§»å‹•
        function travelToCity(cityId, days) {
            const targetCity = cities.find(c => c.id === cityId);
            if (!targetCity) return;
            
            // æ—¥æ•°çµŒéå‡¦ç†
            for (let i = 0; i < days; i++) {
                advanceDay();
            }
            
            // ç¾åœ¨ä½ç½®ã‚’æ›´æ–°
            gameState.currentCity = targetCity.name;
            
            // UIæ›´æ–°
            updateUI();
            
            // ãƒ­ã‚°ã«è¨˜éŒ²
            addLogMessage(`${targetCity.name}ã«ç§»å‹•ã—ã¾ã—ãŸã€‚ï¼ˆ${days}æ—¥çµŒéï¼‰`);
            
            // å£²å´å¯èƒ½ãªå•†å“ãŒã‚ã‚Œã°ææ¡ˆ
            const activeShip = getActiveShip();
            const profitableGoods = [];
            
            activeShip.cargo.forEach(item => {
                const good = goods.find(g => g.id === item.id);
                const cityMarket = marketData[cityId][item.id];
                const profit = (cityMarket.sellPrice * item.quantity) - (item.purchasePrice * item.quantity);
                
                if (profit > 0) {
                    const profitPercent = Math.round((profit / (item.purchasePrice * item.quantity)) * 100);
                    profitableGoods.push({
                        name: good.name,
                        profit: profit,
                        profitPercent: profitPercent
                    });
                }
            });
            
            if (profitableGoods.length > 0) {
                profitableGoods.sort((a, b) => b.profitPercent - a.profitPercent);
                
                let message = 'å£²å´å¯èƒ½ãªå•†å“: ';
                profitableGoods.forEach((item, index) => {
                    if (index > 0) message += ', ';
                    message += `${item.name} (åˆ©ç›Š${item.profitPercent}%)`;
                });
                
                addLogMessage(message);
            }
        }
        
        // æ¬¡ã®æ—¥ã¸é€²ã‚€
        function advanceDay() {
            gameState.day += 1;
            
            // å„èˆ¹ã®è²¨ç‰©ã®è…æ•—é€²è¡Œ
            gameState.ships.forEach(ship => {
                ship.cargo.forEach(item => {
                    const good = goods.find(g => g.id === item.id);
                    if (good.spoilage > 0) {
                        item.daysHeld += 1;
                        
                        // å®Œå…¨ã«è…æ•—ã—ãŸå ´åˆã¯ãƒ­ã‚°ã«è¨˜éŒ²
                        if (item.daysHeld === good.spoilage) {
                            addLogMessage(`${ship.name}ã®${item.name}ãŒè…æ•—ã—ã¾ã—ãŸã€‚å¤§å¹…ã«ä¾¡å€¤ãŒä¸‹ãŒã‚Šã¾ã™ã€‚`);
                        } else if (item.daysHeld === Math.floor(good.spoilage * 0.75)) {
                            addLogMessage(`${ship.name}ã®${item.name}ãŒåŠ£åŒ–ã—ã¦ãã¦ã„ã¾ã™ã€‚ã‚ã¨${good.spoilage - item.daysHeld}æ—¥ã§è…æ•—ã—ã¾ã™ã€‚`);
                        }
                    }
                });
            });
            
            // å¸‚å ´ä¾¡æ ¼ã®å¤‰å‹•
            updateMarkets();
            
            // UIæ›´æ–°
            updateUI();
        }
        
        // ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
        function addLogMessage(message) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<strong>Day ${gameState.day}:</strong> ${message}`;
            gameLog.prepend(logEntry);
            
            // ãƒ­ã‚°ã®æœ€å¤§è¡¨ç¤ºæ•°ã‚’åˆ¶é™
            while (gameLog.children.length > 100) {
                gameLog.removeChild(gameLog.lastChild);
            }
        }
        
        // UIã‚’æ›´æ–°
        function updateUI() {
            const activeShip = getActiveShip();
            
            dayDisplay.textContent = `æ—¥æ•°: ${gameState.day}`;
            moneyDisplay.textContent = `æ‰€æŒé‡‘: ${gameState.money} é‡‘è²¨`;
            locationDisplay.textContent = `ç¾åœ¨åœ°: ${gameState.currentCity}`;
            activeShipDisplay.textContent = `ä½¿ç”¨ä¸­: ${activeShip.name}`;
            
            renderCities();
            renderMarket();
            renderCargo();
            renderShips();
            renderShipyard();
        }
        
        // ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–
        function initGame() {
            gameState.day = 1;
            gameState.money = 1000;
            gameState.currentCity = "ãƒªã‚¹ãƒœãƒ³";
            
            // æœ€åˆã®èˆ¹ã‚’è¿½åŠ ï¼ˆå°å‹å•†èˆ¹ï¼‰
            const initialShip = createShip("small_trader");
            gameState.ships = [initialShip];
            gameState.activeShipIndex = 0;
            
            initializeMarkets();
            updateUI();
            
            // ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ­ã‚°
            addLogMessage("ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚ãƒªã‚¹ãƒœãƒ³ã‹ã‚‰è²¿æ˜“ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼");
            addLogMessage("ãƒ¯ã‚¤ãƒ³ã€å¡©ã€é­šãªã©ã®å•†å“ã¯ãƒªã‚¹ãƒœãƒ³ã§å®‰ãå£²ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ä»–ã®éƒ½å¸‚ã¸é‹ã¶ã¨åˆ©ç›ŠãŒå‡ºã¾ã™ï¼");
        }
        
        // æ¬¡ã®æ—¥ã¸é€²ã‚€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        advanceDayBtn.addEventListener('click', () => {
            advanceDay();
            addLogMessage("1æ—¥ãŒçµŒéã—ã¾ã—ãŸã€‚");
        });
        
        // ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–ã—ã¦é–‹å§‹
        initGame();
    </script>
</body>
</html>
